name: E2E Seed & Test

on:
  pull_request:
  push:
    branches:
      - feat/*
      - main

jobs:
  e2e:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci

      - name: Start docker compose
        run: |
          docker compose -f docker-compose.yml -f docker-compose.override.yml up -d --build
      - name: Docker compose version
        run: |
          docker compose version

      - name: Wait for gateway
        run: |
          echo "Waiting for gateway to be ready..."
          i=0
          until curl --fail http://localhost:8000/api/ || [ $i -ge 30 ]; do
            i=$((i+1))
            echo "Waiting for gateway... ($i)"
            sleep 5
          done
          if [ $i -ge 30 ]; then
            echo "Gateway didn't become ready in time"; exit 1
          fi

      - name: Run seed (dev)
        run: |
          cd frontend
          npm run seed:dev:force

      - name: Run E2E - register/verify/login
        run: |
          cd frontend
          npm run e2e:register

      - name: Run E2E - marketplace
        run: |
          cd frontend
          npm run e2e:marketplace

      - name: Cleanup seeded data
        run: |
          cd frontend
          npm run cleanup:seed:force
      - name: Tear down docker compose
        if: always()
        run: |
          docker compose -f docker-compose.yml -f docker-compose.override.yml down -v
